<!DOCTYPE html>
<html>
  <head>
  <!-- Meta -->
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>Writings on code | Ben Jackson</title>
  <meta name="description" content="A programming blog">
  <link rel="stylesheet" href="/css/main.css">
  <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" />
  <link rel="shortcut icon" type="image/png" href="img/favicon.png?">
</head>

  <body>
    <div id="wrap">
      <nav id="nav">
  <div id="nav-list">
    <a href="/">Home</a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <a href="/about">About me</a>
<a href="mailto:ben@writingsoncode.com">Email</a>
<a href="https://github.com/bjackson2" target="_blank">Github</a>

  </div>
</nav>


      <a id="nav-menu">
        <div id="menu"></div>
      </a>

      <header id="header" class="parent justify-spaceBetween">
  <div class="inner w100 relative">
    <span class="f-left">
      <a href="/" class="dark">
        <h1>
          Writings on code <span class="subtitle">| Ben Jackson</span>
        </h1>
      </a>
    </span>
    <span id="nav-links" class="absolute right bottom">
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
      <a href="/about">About me</a>
<a href="mailto:ben@writingsoncode.com">Email</a>
<a href="https://github.com/bjackson2" target="_blank">Github</a>

    </span>
  </div>
</header>


      <div id="container">
        <main>
        <ul id="posts">
  

  <li class="post">
    <h2><a href="/youve-been-flagged" class="dark">You've been flagged.</a></h2>
    <time datetime="2017-05-08T00:00:00-04:00" class="by-line"> <i>08 May 2017</i> </time>
    <p><p>Let’s play a game. I want you to take a look at the following function call and guess what it does:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">deleteAllUsers</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span></code></pre></figure>

<p>Do you have it? If you answer was ‘uh, it does nothing’, then you’re correct! See, deleting all the users isn’t so scary. So how does it work its magic?</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="kd">function</span> <span class="nx">deleteAllUsers</span><span class="p">(</span><span class="nx">inProductionMode</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">inProductionMode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">fetch</span><span class="p">(</span><span class="s2">"/users"</span><span class="p">,</span> <span class="p">{</span> <span class="na">method</span><span class="p">:</span> <span class="s2">"DELETE"</span> <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">alert</span><span class="p">(</span><span class="s2">"You have no more users! Time to retire."</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>A-ha, we have ourselves a ‘magic flag’!</p>

<div class="image-wrapper">
  <img src="/assets/images/itsmagic.jpg" width="500px" alt="It's magic!" />
</div>

<p>A magic flag is an argument whose value changes the behavior of the function being called. These usually show up as booleans, but they can also be numbers, objects, special secret strings…  you name it. Things get especially interesting when you combine several different types together. Let’s sprinkle in some defaults too, cuz why not?</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">display_contacts</span><span class="p">(</span><span class="n">contacts</span><span class="p">,</span> <span class="n">user_is_mobile</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s2">"condensed"</span><span class="p">)</span>
  <span class="c1"># fun stuff</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>What does that thing do? What inputs are being passed to it, and why? And what will be returned? Your guess is as good as mine. When you’re reading a method’s code, magic flags make it hard to tell what’s actually going on.</p>

<p>Adding a magic flag usually means that you’re splitting each code path in two, which in the best case means there are now 2<sup>n</sup> paths through your function. Have three flags? There are now eight different possible outcomes you need to think about. Trying to work with code like that is bad news bears.</p>

<p>It’s also difficult to reason about why the different code paths exist, and under what circumstances they’d be used. Odds are, you’ll probably have to search through the entire codebase to examine every usage for context. And so will everyone else who reads the code. Who doesn’t love a good word search?</p>

<div class="image-wrapper">
  <img src="/assets/images/dog-search.jpg" width="500px" alt="Find the Dog" />
</div>

<p>Now imagine you’re deep in the wilds of the codebase, and you come across a call to the above method.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">contacts_list</span> <span class="o">=</span> <span class="n">display_contacts</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">contacts</span><span class="p">,</span> <span class="kp">true</span><span class="p">,</span> <span class="s2">"full"</span><span class="p">)</span></code></pre></figure>

<p>That line of code is quite puzzling. Why is there a random boolean argument? What does <code class="highlighter-rouge">"full"</code> mean? Welp, guess we have to go look it up and find out. And I guarantee you’ll have to keep looking it up every time you come across it. By using magic flags, the author of the function is forcing the person calling it to know about the internal implementation details. Note that this is different than knowing what a function <em>does</em>. We use functions every day without having to read the source code, because we know what they <em>do</em>. That’s how well-written code works - you shouldn’t have to worry about the implementation details in most cases. But when you start adding in flags, you almost always need to peek behind the curtain to see what voodoo magic is going on. It’s a bit personal, don’t you think?</p>

<div class="image-wrapper">
  <img src="/assets/images/wizard-of-oz.gif" width="500px" alt="Behind the curtain..." />
</div>

<p>How does code like this come about? And what can be done about it? In most cases, I’ve found that magic flags creep in after the original function has been written. Often someone will need it to do a slightly different thing, and rather than writing a separate function, they add in a flag to modify the behavior.</p>

<p>Luckily, this is usually a pretty straight-forward refactor, and can often be solved using function composition. Passing in a flag to a function means that there are now two different code paths to travel down, usually a base case and some optional tacked-on behavior. The base case can be separated out into its own function, and the optional behavior can be a separate function that calls the base function. To illustrate, let’s take a look at an example similar to something I worked on recently.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">item_description</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">is_full_length</span> <span class="o">=</span> <span class="kp">true</span><span class="p">)</span>
  <span class="n">description</span> <span class="o">=</span> <span class="n">is_full_length</span> <span class="p">?</span> <span class="n">item</span><span class="p">.</span><span class="nf">description</span> <span class="p">:</span> <span class="n">item</span><span class="p">.</span><span class="nf">short_description</span>

  <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="nf">available?</span>
    <span class="n">description</span> <span class="o">||</span> <span class="s2">""</span>
  <span class="k">else</span>
    <span class="no">Item</span><span class="o">::</span><span class="no">DEFAULT_DESCRIPTION</span><span class="p">[</span><span class="n">item</span><span class="p">.</span><span class="nf">status</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>This method existed originally as just a simple way to show either an item’s description or some default text. As the codebase grew, item descriptions were needed in other places as well, but not always the ‘full’ version. So a magic flag was added to change the behavior. UI code changes every so often, so what happens when someone needs a slightly different version in a few months? Will this grow into</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">item_description</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">is_full_length</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="s2">"tablet"</span><span class="p">)</span></code></pre></figure>

<p>Hell no! Not on my watch. Let’s start by teasing out the base conditional:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">item_description_with_default</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="nf">available?</span>
    <span class="n">description</span> <span class="o">||</span> <span class="s2">""</span>
  <span class="k">else</span>
    <span class="no">Item</span><span class="o">::</span><span class="no">DEFAULT_DESCRIPTION</span><span class="p">[</span><span class="n">item</span><span class="p">.</span><span class="nf">status</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Now we have a foundation to build on. Instead of using a flag to alter behavior, let’s compose two new methods that call the <code class="highlighter-rouge">item_description_with_default</code> method.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">item_description</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
  <span class="n">item_description_with_default</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="nf">description</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">short_item_description</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
  <span class="n">item_description_with_default</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="nf">short_description</span><span class="p">)</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Yah, naming is hard. But now adding new variations is easy! No magic flags needed. The base behavior is still shared, and we can easily compose new methods to get the output we need. The arguments make sense to the reader, and they don’t need to bother with implementation details. Problem solved!</p>

<p>Granted, things aren’t usually this simple, and searching through a codebase for 30 slightly different calls to the same function will make you reconsider your life choices. But over time, removing magic flags like this will make things a whole lot easier.</p>
</p>
  </li>

  
</ul>

        </main>

        
      </div>

      <footer><span>Made with <a href="https://github.com/dyutibarma/monochrome" target="_blank">Monochrome</a> theme.</span></footer>

      <script src="/js/main.js"></script>	

    </div>
  </body>
</html>
